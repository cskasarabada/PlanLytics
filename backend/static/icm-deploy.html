<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy to Oracle ICM - ICM PlanLytics</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'DM Sans', sans-serif; color: #0f172a; background: #f8fafc; }
        h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; }
        .step-badge { width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
        .step-badge.active { background: #3b82f6; color: white; }
        .step-badge.done { background: #22c55e; color: white; }
        .step-badge.pending { background: #e2e8f0; color: #94a3b8; }
        .log-line { font-family: 'Courier New', monospace; font-size: 13px; padding: 4px 0; position: relative; display: flex; align-items: flex-start; gap: 6px; }
        .log-line.success { color: #16a34a; }
        .log-line.error { color: #dc2626; }
        .log-line.info { color: #2563eb; }
        .log-line .log-text { flex: 1; word-break: break-all; }
        .copy-btn { flex-shrink: 0; background: #334155; color: #94a3b8; border: none; border-radius: 4px; padding: 2px 6px; font-size: 11px; cursor: pointer; opacity: 0.5; transition: opacity 0.2s; font-family: 'DM Sans', sans-serif; }
        .copy-btn:hover { opacity: 1; color: #e2e8f0; }
        .copy-btn.copied { color: #4ade80; opacity: 1; }
    </style>
</head>
<body>
    <nav class="bg-white/90 backdrop-blur shadow-sm fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-500 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">ICM</span>
                    </div>
                    <div>
                        <a href="index.html" class="text-xl font-bold text-gray-900">ICM PlanLytics</a>
                        <span class="text-xs bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full ml-2">DEPLOY</span>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-5 text-sm">
                    <a href="ai-plan-analytics.html" class="text-gray-600 hover:text-blue-600">AI Plan Analytics</a>
                    <a href="icm-e2e.html" class="text-gray-600 hover:text-blue-600">ICM E2E</a>
                    <a href="ai-plan-studio.html" class="text-gray-600 hover:text-blue-600">Plan Studio</a>
                    <a href="sales-360-ai.html" class="text-gray-600 hover:text-blue-600">Sales 360 AI</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-16 px-4">
        <div class="max-w-3xl mx-auto">
            <div class="text-center mb-10">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Deploy to Oracle Fusion ICM</h1>
                <p class="text-slate-600" id="analysis-info">Upload your Oracle config and deploy the ICM workbook.</p>
            </div>

            <!-- Step indicators -->
            <div class="flex items-center justify-center gap-4 mb-10">
                <div class="flex items-center gap-2">
                    <span id="step1-badge" class="step-badge active">1</span>
                    <span class="text-sm text-slate-700">Upload Config</span>
                </div>
                <div class="w-8 h-px bg-slate-300"></div>
                <div class="flex items-center gap-2">
                    <span id="step2-badge" class="step-badge pending">2</span>
                    <span class="text-sm text-slate-400">Validate</span>
                </div>
                <div class="w-8 h-px bg-slate-300"></div>
                <div class="flex items-center gap-2">
                    <span id="step3-badge" class="step-badge pending">3</span>
                    <span class="text-sm text-slate-400">Deploy</span>
                </div>
            </div>

            <!-- Step 1: Upload Config -->
            <div id="step1-panel" class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <h2 class="text-xl font-semibold text-slate-900 mb-4">Step 1: Upload Oracle Configuration</h2>
                <p class="text-slate-600 mb-6">Upload the <code class="bg-slate-100 px-2 py-0.5 rounded text-sm">config.txt</code> file with your Oracle ICM API credentials.</p>

                <div id="config-upload-area" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-400 transition-colors cursor-pointer mb-4">
                    <svg class="mx-auto h-10 w-10 text-slate-400 mb-3" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <div class="text-slate-900 font-medium mb-1">Drop config.txt here or click to browse</div>
                    <div class="text-xs text-slate-400">INI format with [api] section (base_url, username, password)</div>
                    <input type="file" id="config-file-input" class="hidden" accept=".txt,.ini,.cfg,.yaml,.yml">
                </div>

                <div id="config-info" class="hidden p-4 bg-emerald-50 border border-emerald-200 rounded-lg mb-4">
                    <div class="text-emerald-700 font-medium" id="config-file-name"></div>
                    <div class="text-sm text-emerald-600 mt-1" id="config-details"></div>
                </div>

                <div id="step1-error" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm mb-4"></div>

                <div class="relative flex items-center my-5">
                    <div class="flex-grow border-t border-slate-300"></div>
                    <span class="mx-4 text-xs text-slate-400 font-medium">OR ENTER CREDENTIALS DIRECTLY</span>
                    <div class="flex-grow border-t border-slate-300"></div>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Oracle Site URL</label>
                        <input type="url" id="direct-base-url" placeholder="https://fa-ewrm-dev2-saasfaprod1.fa.ocs.oraclecloud.com" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Username</label>
                            <input type="text" id="direct-username" placeholder="ICM_ADMIN" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Password</label>
                            <input type="password" id="direct-password" placeholder="Password" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm">
                        </div>
                    </div>
                    <button onclick="useDirectCredentials()" class="w-full bg-indigo-600 text-white py-2.5 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors text-sm">
                        Connect with Credentials
                    </button>
                </div>
            </div>

            <!-- Step 2: Validate Settings -->
            <div id="step2-panel" class="hidden bg-white rounded-2xl shadow-lg p-8 mb-6">
                <h2 class="text-xl font-semibold text-slate-900 mb-4">Step 2: Validate Settings</h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="api-password" placeholder="Enter Oracle API password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none">
                    <div class="text-xs text-slate-500 mt-1">Password is not stored from the config file for security.</div>
                </div>

                <table class="w-full text-sm mb-6">
                    <tbody>
                        <tr class="border-b border-slate-100"><td class="py-2 text-slate-500 w-36">Base URL</td><td id="val-base-url" class="py-2 text-slate-900 font-medium"></td></tr>
                        <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Username</td><td id="val-username" class="py-2 text-slate-900 font-medium"></td></tr>
                        <tr class="border-b border-slate-100"><td class="py-2 text-slate-500">Excel Path</td><td id="val-excel-path" class="py-2 text-slate-900 font-medium text-xs break-all"></td></tr>
                    </tbody>
                </table>

                <div class="flex gap-3 mb-4">
                    <button onclick="validateApi()" class="flex-1 bg-blue-600 text-white py-2.5 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors text-sm">
                        Validate API Connection
                    </button>
                    <button onclick="validateExcel()" class="flex-1 bg-slate-700 text-white py-2.5 px-4 rounded-lg font-medium hover:bg-slate-600 transition-colors text-sm">
                        Validate Excel File
                    </button>
                </div>

                <div id="validation-result" class="hidden p-3 rounded-lg text-sm mb-4"></div>

                <!-- Business Unit (OrgId) Selection â€” shown after API validation -->
                <div id="org-selection" class="hidden border border-slate-200 rounded-xl p-5 mb-4 bg-slate-50">
                    <h3 class="text-sm font-semibold text-slate-900 mb-3">Select Business Unit</h3>
                    <p class="text-xs text-slate-500 mb-3">Choose the Oracle Business Unit (OrgId) where objects will be deployed.</p>

                    <div id="org-loading" class="hidden text-sm text-blue-600 mb-3">
                        <svg class="animate-spin inline h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                        Querying Oracle for Business Units...
                    </div>

                    <div id="org-dropdown-wrapper" class="hidden mb-3">
                        <select id="org-dropdown" onchange="onOrgSelected()" class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-white focus:border-blue-500 focus:outline-none text-sm">
                            <option value="">-- Select a Business Unit --</option>
                        </select>
                    </div>

                    <div id="org-error" class="hidden p-2 bg-amber-50 border border-amber-200 rounded-lg text-amber-700 text-xs mb-3"></div>

                    <div class="flex items-end gap-2">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-600 mb-1">Or enter OrgId manually</label>
                            <input type="text" id="org-manual-input" placeholder="e.g. 300000005500455" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm">
                        </div>
                        <button onclick="applyManualOrg()" class="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm font-medium hover:bg-slate-600 transition-colors">
                            Apply
                        </button>
                    </div>

                    <div id="org-confirmed" class="hidden mt-3 p-2 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-700 text-sm font-medium"></div>
                </div>

                <button id="proceed-deploy-btn" onclick="proceedToDeploy()" disabled class="w-full bg-emerald-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-emerald-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors">
                    Proceed to Deploy
                </button>
            </div>

            <!-- Step 3: Deploy -->
            <div id="step3-panel" class="hidden bg-white rounded-2xl shadow-lg p-8 mb-6">
                <h2 class="text-xl font-semibold text-slate-900 mb-4">Step 3: Deploy to Oracle ICM</h2>
                <p class="text-slate-600 mb-4">This will create the following objects in Oracle Fusion ICM:</p>

                <div class="grid grid-cols-3 gap-3 text-sm text-slate-700 mb-6">
                    <div class="bg-slate-50 rounded-lg p-3 text-center">Rate Dimensions</div>
                    <div class="bg-slate-50 rounded-lg p-3 text-center">Rate Tables</div>
                    <div class="bg-slate-50 rounded-lg p-3 text-center">Expressions</div>
                    <div class="bg-slate-50 rounded-lg p-3 text-center">Perf Measures</div>
                    <div class="bg-slate-50 rounded-lg p-3 text-center">Plan Components</div>
                    <div class="bg-slate-50 rounded-lg p-3 text-center">Comp Plans</div>
                </div>

                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-800 text-sm mb-6">
                    <strong>Note:</strong> This process may take several minutes. Do not close this page during execution.
                </div>

                <button id="run-deploy-btn" onclick="runDeployment()" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-emerald-700 transition-colors">
                    Run Deployment
                </button>

                <div id="deploy-log" class="hidden mt-6 bg-slate-900 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <div id="deploy-log-content"></div>
                </div>

                <div id="deploy-result" class="hidden mt-4 p-4 rounded-lg text-center font-semibold"></div>

                <div id="deploy-downloads" class="hidden mt-4 flex flex-wrap gap-3 justify-center">
                    <a id="dl-configured-wb" href="#" class="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Configured Workbook (.xlsx)
                    </a>
                    <a id="dl-deploy-log" href="#" class="inline-flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Deploy Log (.json)
                    </a>
                </div>
            </div>

            <!-- Back to Analytics link -->
            <div class="text-center mt-8">
                <a href="ai-plan-analytics.html" class="text-blue-600 hover:text-blue-700 text-sm font-medium">&larr; Back to AI Plan Analytics</a>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;
        const params = new URLSearchParams(window.location.search);
        const analysisId = params.get('analysis_id') || '';
        let configId = null;
        let baseUrl = '';
        let username = '';
        let apiValidated = false;
        let excelValidated = false;
        let selectedOrgId = 0;
        let directMode = false;
        let directPassword = '';

        // Show analysis info
        if (analysisId) {
            document.getElementById('analysis-info').textContent = `Deploying workbook from analysis: ${analysisId}`;
            document.getElementById('val-excel-path').textContent = `/tmp/outputs/icm_${analysisId}.xlsx`;
        }

        // Step 1: Config upload
        const configUploadArea = document.getElementById('config-upload-area');
        const configFileInput = document.getElementById('config-file-input');

        configUploadArea.addEventListener('click', () => configFileInput.click());
        configUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); configUploadArea.classList.add('border-blue-500'); });
        configUploadArea.addEventListener('dragleave', () => configUploadArea.classList.remove('border-blue-500'));
        configUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            configUploadArea.classList.remove('border-blue-500');
            if (e.dataTransfer.files.length) {
                configFileInput.files = e.dataTransfer.files;
                uploadConfig(e.dataTransfer.files[0]);
            }
        });

        configFileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) uploadConfig(e.target.files[0]);
        });

        async function uploadConfig(file) {
            const errEl = document.getElementById('step1-error');
            errEl.classList.add('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API_BASE}/api/icm-deploy/upload-config`, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.config_id) {
                    configId = data.config_id;
                    baseUrl = data.base_url || '';
                    username = data.username || '';

                    document.getElementById('config-file-name').textContent = file.name + ' uploaded';
                    document.getElementById('config-details').textContent = `Config ID: ${configId} | Sections: ${(data.sections || []).join(', ')}`;
                    document.getElementById('config-info').classList.remove('hidden');

                    // Advance to step 2
                    document.getElementById('step1-badge').className = 'step-badge done';
                    document.getElementById('step2-badge').className = 'step-badge active';
                    document.getElementById('step2-panel').classList.remove('hidden');
                    document.getElementById('val-base-url').textContent = baseUrl;
                    document.getElementById('val-username').textContent = username;
                } else {
                    errEl.textContent = data.message || data.error || 'Upload failed';
                    errEl.classList.remove('hidden');
                }
            } catch (e) {
                errEl.textContent = 'Upload failed: ' + e.message;
                errEl.classList.remove('hidden');
            }
        }

        // Step 2: Validation
        async function validateApi() {
            const resultEl = document.getElementById('validation-result');
            const password = document.getElementById('api-password').value;
            if (!password) { showValidation(resultEl, false, 'Please enter the API password'); return; }

            showValidation(resultEl, null, 'Validating API connection...');
            try {
                const res = await fetch(`${API_BASE}/api/icm-deploy/validate-api`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ base_url: baseUrl, username, password }),
                });
                const data = await res.json();
                apiValidated = data.success;
                showValidation(resultEl, data.success, data.message);
                if (data.success) fetchOrgs();
                checkProceed();
            } catch (e) {
                showValidation(resultEl, false, 'Validation failed: ' + e.message);
            }
        }

        async function validateExcel() {
            const resultEl = document.getElementById('validation-result');
            const excelPath = `/tmp/outputs/icm_${analysisId}.xlsx`;

            showValidation(resultEl, null, 'Validating Excel file...');
            try {
                const res = await fetch(`${API_BASE}/api/icm-deploy/validate-excel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ excel_path: excelPath }),
                });
                const data = await res.json();
                excelValidated = data.success;
                const msg = data.success ? `${data.message} | Sheets: ${(data.sheets || []).join(', ')}` : data.message;
                showValidation(resultEl, data.success, msg);
                checkProceed();
            } catch (e) {
                showValidation(resultEl, false, 'Validation failed: ' + e.message);
            }
        }

        function showValidation(el, success, msg) {
            el.classList.remove('hidden', 'bg-emerald-50', 'text-emerald-700', 'bg-red-50', 'text-red-700', 'bg-blue-50', 'text-blue-700');
            if (success === null) { el.classList.add('bg-blue-50', 'text-blue-700'); }
            else if (success) { el.classList.add('bg-emerald-50', 'text-emerald-700'); }
            else { el.classList.add('bg-red-50', 'text-red-700'); }
            el.textContent = msg;
        }

        function checkProceed() {
            document.getElementById('proceed-deploy-btn').disabled = !(apiValidated && excelValidated && selectedOrgId > 0);
        }

        // OrgId (Business Unit) selection
        async function fetchOrgs() {
            const orgSection = document.getElementById('org-selection');
            const loadingEl = document.getElementById('org-loading');
            const dropdownWrapper = document.getElementById('org-dropdown-wrapper');
            const dropdown = document.getElementById('org-dropdown');
            const errorEl = document.getElementById('org-error');

            orgSection.classList.remove('hidden');
            loadingEl.classList.remove('hidden');
            dropdownWrapper.classList.add('hidden');
            errorEl.classList.add('hidden');

            const password = document.getElementById('api-password').value;

            try {
                const res = await fetch(`${API_BASE}/api/icm-deploy/list-orgs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ base_url: baseUrl, username, password, analysis_id: analysisId }),
                });
                const data = await res.json();

                loadingEl.classList.add('hidden');

                if (data.success && data.orgs && data.orgs.length > 0) {
                    dropdown.innerHTML = '<option value="">-- Select a Business Unit --</option>';
                    data.orgs.forEach(org => {
                        const opt = document.createElement('option');
                        opt.value = org.org_id;
                        opt.textContent = org.name ? `${org.name} (${org.org_id})` : `OrgId: ${org.org_id}`;
                        dropdown.appendChild(opt);
                    });
                    dropdownWrapper.classList.remove('hidden');
                } else {
                    errorEl.textContent = data.message || 'No Business Units found. Enter OrgId manually below.';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                loadingEl.classList.add('hidden');
                errorEl.textContent = 'Could not query Business Units: ' + e.message + '. Enter OrgId manually.';
                errorEl.classList.remove('hidden');
            }
        }

        function onOrgSelected() {
            const dropdown = document.getElementById('org-dropdown');
            const confirmedEl = document.getElementById('org-confirmed');
            const val = parseInt(dropdown.value, 10);
            if (val && val > 0) {
                selectedOrgId = val;
                confirmedEl.textContent = `Selected OrgId: ${selectedOrgId}`;
                confirmedEl.classList.remove('hidden');
            } else {
                selectedOrgId = 0;
                confirmedEl.classList.add('hidden');
            }
            checkProceed();
        }

        function applyManualOrg() {
            const input = document.getElementById('org-manual-input');
            const confirmedEl = document.getElementById('org-confirmed');
            const val = parseInt(input.value.trim(), 10);
            if (!val || val <= 0 || isNaN(val)) {
                input.classList.add('border-red-400');
                setTimeout(() => input.classList.remove('border-red-400'), 2000);
                return;
            }
            selectedOrgId = val;
            // Also update dropdown if it has a matching option
            const dropdown = document.getElementById('org-dropdown');
            const matchOpt = Array.from(dropdown.options).find(o => parseInt(o.value, 10) === val);
            if (matchOpt) dropdown.value = matchOpt.value;

            confirmedEl.textContent = `Selected OrgId: ${selectedOrgId} (manual entry)`;
            confirmedEl.classList.remove('hidden');
            checkProceed();
        }

        async function useDirectCredentials() {
            const errEl = document.getElementById('step1-error');
            errEl.classList.add('hidden');

            const url = document.getElementById('direct-base-url').value.trim();
            const user = document.getElementById('direct-username').value.trim();
            const pass = document.getElementById('direct-password').value;

            if (!url || !user || !pass) {
                errEl.textContent = 'Please fill in all three fields: URL, username, and password.';
                errEl.classList.remove('hidden');
                return;
            }

            baseUrl = url.replace(/\/+$/, '');
            username = user;
            directPassword = pass;
            directMode = true;

            // Skip config upload, advance to step 2 and auto-validate
            document.getElementById('step1-badge').className = 'step-badge done';
            document.getElementById('step2-badge').className = 'step-badge active';
            document.getElementById('step2-panel').classList.remove('hidden');
            document.getElementById('val-base-url').textContent = baseUrl;
            document.getElementById('val-username').textContent = username;

            // Pre-fill & hide password field since we already have it
            document.getElementById('api-password').value = directPassword;
            document.getElementById('api-password').closest('.mb-4').style.display = 'none';

            // Auto-validate API
            await validateApi();
            // Auto-validate Excel
            await validateExcel();
        }

        function proceedToDeploy() {
            document.getElementById('step2-badge').className = 'step-badge done';
            document.getElementById('step3-badge').className = 'step-badge active';
            document.getElementById('step3-panel').classList.remove('hidden');
        }

        // Step 3: Deploy
        async function runDeployment() {
            const btn = document.getElementById('run-deploy-btn');
            const logEl = document.getElementById('deploy-log');
            const logContent = document.getElementById('deploy-log-content');
            const resultEl = document.getElementById('deploy-result');

            btn.disabled = true;
            btn.textContent = 'Deploying...';
            logEl.classList.remove('hidden');
            resultEl.classList.add('hidden');
            logContent.innerHTML = '<div class="log-line info">Starting deployment...</div>';

            const password = document.getElementById('api-password').value;

            try {
                const res = await fetch(`${API_BASE}/api/icm-deploy/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        analysis_id: analysisId,
                        config_id: configId,
                        password,
                        org_id: selectedOrgId,
                        base_url: directMode ? baseUrl : undefined,
                        username: directMode ? username : undefined,
                    }),
                });
                const data = await res.json();
                const deployment = data.deployment || {};
                const steps = deployment.steps || [];

                logContent.innerHTML = '';
                steps.forEach(step => {
                    const cls = step.success ? 'success' : 'error';
                    const icon = step.success ? 'OK' : 'FAIL';
                    const count = step.request_count ? ` (${step.request_count} requests)` : '';
                    const text = `[${icon}] ${step.name}${count}${step.error ? ' - ' + step.error : ''}`;
                    logContent.innerHTML += logLineHtml(cls, text);
                });

                // Show detailed requests
                const dl = deployment.detailed_log || {};
                const requests = dl.requests || [];
                if (requests.length > 0) {
                    logContent.innerHTML += `<div class="log-line info" style="margin-top:8px;border-top:1px solid #334155;padding-top:8px;"><span class="log-text">--- Detailed Request Log (${requests.length} requests) ---</span></div>`;
                    requests.forEach((req, i) => {
                        const cls = (req.status_code >= 200 && req.status_code < 300) ? 'success' : 'error';
                        const method = req.method || 'GET';
                        const endpoint = req.endpoint || '';
                        const line = `#${i+1} ${req.status_code} ${method} ${endpoint}`;
                        const detail = req.payload ? `\nPayload: ${JSON.stringify(req.payload)}\nResponse: ${JSON.stringify(req.response)}` : '';
                        logContent.innerHTML += logLineHtml(cls, line, line + detail);
                    });
                }

                // Show summary stats
                if (dl.total_requests) {
                    const summaryText = `Timestamp:${dl.started_at || ''} Total:${dl.total_requests} Successful:${dl.successful_requests} Failed:${dl.failed_requests}`;
                    logContent.innerHTML += `<div class="log-line info" style="margin-top:8px;border-top:1px solid #334155;padding-top:8px;"><span class="log-text">${summaryText}</span><button class="copy-btn" onclick="copyLogText(this, '${escapeForAttr(summaryText)}')">Copy</button></div>`;
                }

                resultEl.classList.remove('hidden', 'bg-emerald-50', 'text-emerald-800', 'bg-red-50', 'text-red-800');
                const downloadsEl = document.getElementById('deploy-downloads');
                if (deployment.success) {
                    resultEl.classList.add('bg-emerald-50', 'text-emerald-800');
                    resultEl.textContent = 'Deployment completed successfully!';
                    document.getElementById('step3-badge').className = 'step-badge done';
                } else {
                    resultEl.classList.add('bg-red-50', 'text-red-800');
                    resultEl.textContent = deployment.error || 'Deployment failed. Check detailed log below.';
                }

                // Show download buttons (always after deployment, success or not)
                downloadsEl.classList.remove('hidden');
                document.getElementById('dl-configured-wb').href = `${API_BASE}/api/configured-workbook/${analysisId}`;
                const dlLogLink = document.getElementById('dl-deploy-log');
                dlLogLink.href = `${API_BASE}/api/deploy-log/${analysisId}`;
                dlLogLink.setAttribute('download', `deploy_log_${analysisId}.json`);
            } catch (e) {
                logContent.innerHTML += `<div class="log-line error">Error: ${e.message}</div>`;
                resultEl.classList.remove('hidden');
                resultEl.classList.add('bg-red-50', 'text-red-800');
                resultEl.textContent = 'Deployment request failed: ' + e.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Deployment';
            }
        }
        // Helper: escape text for use in HTML attribute
        function escapeForAttr(s) {
            return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '\\n');
        }

        // Helper: build a log line with copy button
        function logLineHtml(cls, displayText, copyText) {
            const ct = copyText || displayText;
            return `<div class="log-line ${cls}"><span class="log-text">${displayText}</span><button class="copy-btn" onclick="copyLogText(this, \`${ct.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)">Copy</button></div>`;
        }

        // Copy log text to clipboard
        function copyLogText(btn, text) {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
            });
        }
    </script>
</body>
</html>
